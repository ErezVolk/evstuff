#!/usr/bin/env python3
import argparse
import requests
import lxml.etree
from io import StringIO
import os.path
import re


class BingWallpaper:
    BASE = "https://www.bing.com/"
    PATH = os.path.expanduser("~/Pictures/bing-wallpapers")

    def run(self):
        parser = argparse.ArgumentParser(description="Download Bing wallpaper")
        parser.add_argument(
            "-f",
            "--force",
            action="store_true",
            help="Download even if already exists.",
        )
        args = parser.parse_args()

        page_r = requests.get(self.BASE)
        parser = lxml.etree.HTMLParser()
        html = lxml.etree.parse(StringIO(page_r.text), parser)
        for e in html.xpath('./head/link[@as="image"]'):
            href = e.get("href")
            m = re.search(r"[.&=?]([^.&=?]*\.jpg)[.&=?]", href)
            if not m:
                print(f"I don't know what to do with {lxml.etree.tostring(e)}")
                continue
            url = f"{self.BASE}/{href}"
            fn = m.group(1)
            path = os.path.join(self.PATH, fn)
            if os.path.isfile(path):
                if not args.force:
                    print(f"Already downloaded {fn}")
                    continue

            print(f"Downloading {fn}")

            file_r = requests.get(url)
            with open(path, "wb") as fo:
                fo.write(file_r.content)


if __name__ == "__main__":
    BingWallpaper().run()
