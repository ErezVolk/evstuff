#!/bin/sh

# Update Git repo and pull if safe, and watch the traffic
# Based on https://stackoverflow.com/a/3278427

git remote update --prune || exit
REMOTE=`git rev-parse @{u}` || exit
LOCAL=`git rev-parse @`
BASE=`git merge-base $LOCAL $REMOTE`
ROOT=`git rev-parse --show-toplevel`

if [[ -z $(git status --porcelain --untracked-files=no) ]]; then
    if [ $LOCAL = $REMOTE ]; then
        echo "✔ $ROOT"
        exit 0
    elif [ $LOCAL = $BASE ]; then
        echo $ROOT
        git merge --ff-only $REMOTE
    elif [ $REMOTE = $BASE ]; then
        echo "↑ $ROOT"
    else
        echo "⇅ $ROOT"
    fi
else
    echo "! $ROOT"
fi
