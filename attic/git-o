#!/bin/sh

# Update Git repo and pull if safe, without excessive traffic.

ROOT=`git rev-parse --show-toplevel` || exit  # Fails if not a Git repo
printf "… %s " "$ROOT"
git fetch --prune --all || exit   # Fails if no remote; this is the only server communication
printf "\b\r"

REMOTE=`git rev-parse @{u}` || exit  # Fails if not a remote-tracking branch
LOCAL=`git rev-parse @`
BASE=`git merge-base $LOCAL $REMOTE`

STATUS=`git status --porcelain --untracked-files=no`
if [ -n "$STATUS" ]; then
    echo "!"  # Local uncommitted changes
elif [ $LOCAL = $REMOTE ]; then
    echo "✔"  # Up to date
elif [ $LOCAL = $BASE ]; then
    echo "⇣"  # What we can here for
    git merge --ff-only $REMOTE
elif [ $REMOTE = $BASE ]; then
    echo "⇡"  # Need to push
else
    echo "⇅"  # Diverged
fi
