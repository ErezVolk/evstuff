#!/usr/bin/env python3
import argparse
import random
import subprocess
import sqlalchemy
import sqlalchemy.orm
import sqlalchemy.ext.declarative
from tatoeba import *


JA_VOICES = ['kyoko', 'otoya']
EN_VOICES = ['alex', 'bruce', 'daniel', 'fred', 'kathy', 'vicki', 'victoria']


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('-d', '--db', metavar='SQLITE_FILE',
                        help='Database file',
                        default='tatoeba.sqlite')
    parser.add_argument('-a', '--all', action='store_true',
                        help='Play ALL sentences matching a word')
    parser.add_argument('words', metavar='WORD', nargs='*',
                        help='Japanese words')
    args = parser.parse_args()

    engine = sqlalchemy.create_engine('sqlite:///%s' % args.db)
    session_factory = sqlalchemy.orm.session.sessionmaker(bind=engine, autocommit=True)
    session = session_factory()

    for word in get_words(args.words):
        query = session.query(Link)
        query = query.join(Link.src, aliased=True)
        query = query.filter(Sentence.lang == 'jpn')
        query = query.filter(Sentence.text.like('%%%s%%' % word))
        query = query.join(Link.dst, aliased=True)
        query = query.filter(Sentence.lang != 'jpn')
        good = []
        soso = []

        for link in query:
            if link.src.user_lang:
                good.append((link.src, link.dst))
            else:
                soso.append((link.src, link.dst))

        if good:
            level = 'a'
            sentences = good
        elif soso:
            level = 'b'
            sentences = soso
        else:
            level = 'c'
            query = session.query(JpnIndex)
            query.join(JpnIndex.jpn)
            query.filter(Sentence.text.like('%%%s%%' % word))
            sentences = [(row.jpn, row.eng) for row in query]

        if not sentences:
            print('No sentences found which contain %r' % word)
            print('')
        else:
            if args.all:
                random.shuffle(sentences)
                chosen = sentences
            else:
                chosen = [random.choice(sentences)]
            for jpn, eng in chosen:
                print('[%s%s] %s' % (level, len(sentences), jpn.text))
                subprocess.run(['say', '-v', random.choice(JA_VOICES), jpn.text])

                input('Press Enter to show the translation...')
                print(eng.text)
                print('')

    session.close()


def get_words(cli_words):
    for word in cli_words:
        yield word
    while True:
        try:
            word = input('Enter a japanese word: ')
        except KeyboardInterrupt:
            return
        if not word:
            return
        yield word


if __name__ == '__main__':
    main()
